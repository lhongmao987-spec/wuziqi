# 排行榜功能说明和索引建议

## 一、功能概述

### 1. 数据源
- **唯一数据源**：`userStats` 集合
- **用户标识**：`_openid`（云数据库自动添加）

### 2. 上榜门槛
- `totalGames >= 5` 的用户才能进入排行榜列表
- 未达到门槛的用户会在页面底部显示提示信息

### 3. 评分公式
```
winRate = winCount / totalGames  (totalGames 为 0 时 winRate = 0)
score = winRate * 100 + ln(totalGames) * 20
```
- `ln` 为自然对数
- `totalGames < 1` 时，ln 部分按 0 计算

### 4. 排序规则
1. 按 `score` 降序（从大到小）
2. `score` 相同时，按 `winCount` 降序
3. `score` 和 `winCount` 都相同时，按 `updateTime` 升序（更早的在前，稳定排序）

---

## 二、云函数接口

### 1. `updateUserStatsAfterGame` - 更新用户战绩

**调用时机**：对局结束时

**入参**：
```javascript
{
  result: 'win' | 'lose' | 'draw',  // 必填
  nickName: 'xxx',                  // 可选，用于同步昵称
  avatarUrl: 'xxx',                // 可选，用于同步头像
  gameMode: 'PVE',                 // 可选
  opponentType: 'AI'                // 可选
}
```

**更新规则**：
- `totalGames += 1`（原子自增）
- **win**：`winCount += 1`，`currentStreak += 1`，`maxStreak = max(maxStreak, currentStreak)`
- **lose**：`loseCount += 1`，`currentStreak = 0`
- **draw**：`drawCount += 1`，`currentStreak = 0`（和局不保持连胜）
- 重新计算 `winRate` 和 `score`
- 更新 `updateTime`

**并发安全**：使用数据库原子操作（`db.command.inc`）确保并发安全

---

### 2. `getLeaderboard` - 获取排行榜

**入参**：
```javascript
{
  limit: 50,    // 可选，默认 50
  skip: 0       // 可选，默认 0（分页）
}
```

**返回结构**：
```javascript
{
  success: true,
  data: {
    list: [
      {
        rank: 1,
        nickName: 'xxx',
        avatarUrl: 'xxx',
        openid: 'xxx',
        winCount: 10,
        loseCount: 5,
        totalGames: 15,
        maxStreak: 5,
        winRate: 0.67,  // 保留2位小数
        score: 85.5
      },
      // ...
    ],
    total: 100,  // 总上榜人数
    currentUser: {
      rank: 10,  // 排名（如果已上榜）
      notRanked: false,  // 是否未上榜
      needGames: 0,  // 还差几场（如果未上榜）
      stats: {
        nickName: 'xxx',
        avatarUrl: 'xxx',
        winCount: 10,
        loseCount: 5,
        totalGames: 15,
        maxStreak: 5,
        winRate: 0.67,
        score: 85.5
      }
    }
  }
}
```

**排名计算**：
- 严格按照排序规则（score/winCount/updateTime）计算
- 统计比当前用户排名高的用户数量 + 1

---

## 三、数据库索引建议

### userStats 集合索引

在微信云开发控制台的数据库中，为 `userStats` 集合创建以下索引：

#### 1. 复合索引（用于排行榜查询）
- **索引名称**：`idx_score_totalGames`
- **字段**：
  - `score`（降序）
  - `totalGames`（升序）
- **用途**：支持按 score 排序，同时筛选 totalGames >= 5

#### 2. 单字段索引（用于用户查询）
- **索引名称**：`_openid_1`（系统自动创建）
- **字段**：`_openid`（升序）
- **索引属性**：非唯一（但实际使用中每个用户只有一条记录，效果等同于唯一）
- **用途**：快速查询单个用户的战绩
- **说明**：微信云数据库会自动为以 `_` 开头的字段创建索引，无需手动创建

#### 3. 单字段索引（用于排序辅助）
- **索引名称**：`idx_winCount`
- **字段**：`winCount`（降序）
- **用途**：在内存排序时辅助处理同分情况（可选，因为主要在内存中处理）

#### 4. 单字段索引（用于排序辅助）
- **索引名称**：`idx_updateTime`
- **字段**：`updateTime`（升序）
- **用途**：在内存排序时辅助处理同分情况（可选）

### 创建索引的方法

1. 登录微信云开发控制台
2. 进入「数据库」->「userStats」集合
3. 点击「索引管理」
4. 点击「添加索引」
5. 按上述配置创建索引

**注意**：
- `_openid_1` 索引是系统自动创建的，无需手动创建
- 只需要手动创建 `idx_score_totalGames` 复合索引即可

### 索引优化说明

- **主要查询**：`totalGames >= 5` + `orderBy score desc`
- **必需索引**：`idx_score_totalGames`（复合索引，需手动创建）
- **自动索引**：`_openid_1`（系统自动创建，用于单用户查询）
- 由于微信云数据库不支持多字段排序，同分情况在内存中处理，所以 `winCount` 和 `updateTime` 的索引为可选

### 当前索引状态

根据你的截图，当前 `userStats` 集合已有：
1. ✅ `idx_score_totalGames` - 已创建（复合索引，用于排行榜查询）
2. ✅ `_openid_1` - 系统自动创建（用于单用户查询）
3. ✅ `_id_` - 系统默认索引

**结论**：索引配置已完整，无需额外创建索引。

---

## 四、前端调用示例

### 1. 对局结束时更新战绩

```javascript
// 在游戏结束页面调用
wx.cloud.callFunction({
  name: 'quickstartFunctions',
  data: {
    type: 'updateUserStatsAfterGame',
    data: {
      result: 'win',  // 或 'lose' / 'draw'
      nickName: userInfo.nickName,
      avatarUrl: userInfo.avatarUrl,
      gameMode: 'PVE',
      opponentType: 'AI'
    }
  },
  success: (res) => {
    if (res.result.success) {
      console.log('战绩已更新', res.result.data.stats);
    }
  }
});
```

### 2. 获取排行榜

```javascript
// 在排行榜页面调用
wx.cloud.callFunction({
  name: 'quickstartFunctions',
  data: {
    type: 'getLeaderboard',
    limit: 50,
    skip: 0
  },
  success: (res) => {
    if (res.result.success) {
      const { list, total, currentUser } = res.result.data;
      // 处理排行榜数据
      this.setData({
        ranks: list,
        currentUser: currentUser,
        total: total
      });
    }
  }
});
```

---

## 五、注意事项

1. **并发安全**：`updateUserStatsAfterGame` 使用原子操作，确保并发安全
2. **数据一致性**：如果用户没有 `userStats` 记录，会自动创建（默认值为 0）
3. **昵称头像同步**：更新战绩时会同步 `users` 集合的昵称和头像到 `userStats`
4. **排序限制**：微信云数据库不支持多字段排序，同分情况在内存中处理
5. **性能优化**：排行榜查询限制在 1000 条以内，在内存中排序后分页返回

---

## 六、兼容性说明

- `reportResult` 函数已改造，内部调用 `updateUserStatsAfterGame`
- `getRankList` 函数保留，内部调用 `getLeaderboard`（向后兼容）
- 新接口推荐使用 `updateUserStatsAfterGame` 和 `getLeaderboard`

