# 登录授权问题排查和测试指南

## 问题描述
真机上点击登录授权按钮，无法拉起微信授权登录弹窗，一直显示默认用户（"微信用户"）。

## 问题原因分析

### 1. 微信授权机制变化
- `wx.getUserProfile` 在微信新版本中限制更严格
- 如果用户之前拒绝过授权，微信会缓存拒绝状态
- 未在微信公众平台配置隐私保护指引可能导致授权失败

### 2. 真机与开发工具差异
- 开发工具中 `wx.getUserProfile` 可能直接返回数据，不会真正弹出授权弹窗
- 真机需要用户主动点击授权弹窗中的"允许"按钮
- 真机对授权状态有更严格的缓存机制

### 3. 代码层面的改进
已优化的检查点：
- ✅ 更严格的默认值检测（昵称、头像、is_demote 字段）
- ✅ 更详细的错误提示和用户引导
- ✅ 更完善的日志记录便于调试
- ✅ 按钮类型和属性明确配置

## 解决方案

### 方案一：清除小程序数据（推荐）
这是最常见且有效的解决方法：

1. **在真机上操作：**
   - 打开小程序
   - 点击右上角 `...` 菜单
   - 选择 `设置`
   - 点击 `清除数据` 或 `清除缓存`
   - 完全关闭小程序（从后台划掉）
   - 重新打开小程序
   - 点击 `微信授权登录` 按钮
   - 在弹出的授权弹窗中点击 `允许`

2. **验证步骤：**
   - 确认授权弹窗正常弹出
   - 点击允许后，头像和昵称应该显示为真实的用户信息
   - 不应再显示"微信用户"

### 方案二：检查微信版本
确保微信版本为最新版本（建议 8.0.5 及以上）：
- 打开微信 → 我 → 设置 → 关于微信
- 检查版本号
- 如不是最新版本，请更新

### 方案三：检查隐私保护指引配置
在微信公众平台配置隐私保护指引（必须）：

1. **登录微信公众平台：**
   - 访问 https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **配置隐私保护指引：**
   - 进入 `设置` → `基本设置` → `服务内容声明`
   - 或者在 `开发` → `开发管理` → `接口设置` 中找到 `用户隐私保护指引`
   - 按照提示配置并提交审核

3. **配置用户信息收集说明：**
   - 说明收集用户昵称和头像的目的
   - 例如："用于完善用户资料，显示个人头像和昵称"

## 测试步骤

### 前置条件
1. ✅ 确保已上传云函数到云环境
2. ✅ 确保云数据库已创建 `users` 集合
3. ✅ 确保 `app.json` 中配置了正确的云环境 ID
4. ✅ 确保已在微信公众平台配置隐私保护指引

### 测试步骤

#### 步骤 1：清除小程序数据
```
1. 在真机上打开小程序
2. 点击右上角 "..." 菜单
3. 选择 "设置"
4. 点击 "清除数据"
5. 完全关闭小程序（从最近任务中划掉）
```

#### 步骤 2：重新打开小程序并登录
```
1. 重新打开小程序
2. 进入 "我的" 页面（个人中心）
3. 点击 "微信授权登录" 按钮
4. 观察是否弹出授权弹窗
```

#### 步骤 3：验证授权结果
**期望结果：**
- ✅ 弹出授权弹窗，显示"用于完善用户资料"的描述
- ✅ 点击"允许"后，成功获取用户昵称和头像
- ✅ 昵称不是"微信用户"
- ✅ 头像不是默认头像
- ✅ 用户信息保存到云数据库 `users` 集合

**异常情况：**
- ❌ 没有弹出授权弹窗 → 检查控制台日志，查看错误信息
- ❌ 弹出授权弹窗但点击允许后仍然是默认值 → 检查 `is_demote` 字段和昵称检测逻辑
- ❌ 提示"授权被拒绝" → 清除小程序数据后重试

#### 步骤 4：查看控制台日志
在开发者工具的真机调试中查看日志：

**成功日志应包含：**
```
========== 开始登录流程 ==========
点击登录按钮 - 开始授权流程
当前基础库版本: 3.x.x
准备调用 wx.getUserProfile
========== 授权成功回调 ==========
获取用户信息成功
验证通过，用户信息有效
登录云函数调用成功
保存用户信息成功
```

**失败日志可能包含：**
```
获取到的用户信息是默认值或降级值
is_demote 状态: true
授权失败
```

#### 步骤 5：验证数据库
在云开发控制台检查数据：

```
1. 登录微信开发者工具
2. 打开云开发控制台
3. 进入"数据库" → "users" 集合
4. 查看是否有新记录或更新记录
5. 确认记录中包含正确的 nickName 和 avatarUrl
```

## 常见问题排查

### Q1: 真机上点击按钮没有任何反应
**排查步骤：**
1. 检查按钮是否绑定了 `handleLogin` 事件
2. 查看控制台是否有 JavaScript 错误
3. 确认基础库版本是否 >= 2.10.4

### Q2: 弹出授权弹窗但点击允许后还是默认值
**排查步骤：**
1. 查看控制台日志中的 `is_demote` 状态
2. 检查返回的 `userInfo` 对象内容
3. 确认代码中的默认值检测逻辑是否正确
4. 清除小程序数据后重试

### Q3: 提示"授权被拒绝"或"需要授权"
**解决方案：**
- 清除小程序数据
- 重新打开小程序
- 再次点击登录按钮
- 在授权弹窗中点击"允许"

### Q4: 云函数调用失败
**排查步骤：**
1. 检查云函数是否已部署到云环境
2. 检查 `app.js` 中的云环境 ID 是否正确
3. 查看云函数日志，确认是否有错误
4. 检查云数据库权限设置

### Q5: 开发工具正常但真机异常
**说明：**
- 这是正常现象，开发工具和真机的授权行为不同
- 开发工具可能直接返回模拟数据
- 真机需要真正的用户授权操作

**解决方案：**
- 以真机测试结果为准
- 按照本文档的测试步骤在真机上测试

## 代码修改说明

### 主要改进点

1. **更严格的默认值检测：**
   ```javascript
   const isDefaultNickname = !userInfo.nickName || 
                             userInfo.nickName === '微信用户' || 
                             userInfo.nickName.trim() === '';
   const isDefaultAvatar = !userInfo.avatarUrl || 
                          userInfo.avatarUrl.includes('default') || 
                          userInfo.avatarUrl.includes('placeholder');
   ```

2. **更详细的错误处理：**
   - 区分不同类型的错误（拒绝、取消、未授权等）
   - 提供针对性的解决方案提示

3. **更完善的日志记录：**
   - 记录完整的系统信息和环境信息
   - 记录详细的授权响应数据
   - 便于问题排查和调试

4. **按钮配置优化：**
   ```xml
   <button type="default" size="default" bindtap="handleLogin">
   ```

## 后续优化建议

1. **考虑使用新的授权方式：**
   - 微信正在推动使用 `<button open-type="chooseAvatar">` 获取头像
   - 配合昵称输入框获取昵称
   - 这是微信推荐的未来方案

2. **添加授权状态检测：**
   - 在页面加载时检测是否已授权
   - 如果已授权但信息过期，提示重新授权

3. **优化用户体验：**
   - 添加加载状态提示
   - 优化错误提示文案
   - 添加重试机制

## 联系支持

如果按照以上步骤操作后问题仍然存在，请提供以下信息：
1. 微信版本号
2. 小程序基础库版本
3. 控制台完整日志
4. 操作步骤截图
5. 云函数日志（如果有错误）

